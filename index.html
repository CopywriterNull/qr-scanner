<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style.css" />
    <title>QR Scanner</title>
    <script
      src="https://unpkg.com/qr-scanner/qr-scanner.min.js"
      type="module"
    ></script>
    <style>
      #log-container {
        max-height: 200px; /* Adjust height as needed */
        overflow-y: auto; /* Enable scrolling */
        background: #f9f9f9; /* Background for visibility */
        border: 1px solid #ccc; /* Border around log */
        padding: 10px; /* Padding inside log */
        margin-top: 20px; /* Space above log */
      }
    </style>
  </head>
  <body>
    <video
      id="qr-video"
      width="300"
      height="300"
      style="border: 1px solid black"
    ></video>
    <p id="result"></p>

    <div id="log-container"></div>
    <!-- Log container -->

    <script type="module">
            import QrScanner from "https://unpkg.com/qr-scanner/qr-scanner.min.js";

            const videoElem = document.getElementById("qr-video");
            const resultElem = document.getElementById("result");
            const logContainer = document.getElementById("log-container");

            // Override console methods to log messages to the div
            const originalLog = console.log;
            const originalError = console.error;

            console.log = function (...args) {
              originalLog.apply(console, args);
              logContainer.innerHTML += `<p>${args.join(" ")}</p>`;
            };

            console.error = function (...args) {
              originalError.apply(console, args);
              logContainer.innerHTML += `<p style="color: red;">${args.join(" ")}</p>`;
            };

            const qrScanner = new QrScanner(videoElem, (result) => {
              resultElem.textContent = "QR Code scanned: " + result;

              console.log("Scanned result:", result); // Log the entire scanned result

              // Validate and extract email from the QR code response
              const urlPattern = /^(https?:\/\/[^\s]+)/; // Regex to match URLs
              const emailPattern = /[?&]email=([^&#]+)/; // Regex to match the email parameter
              const urlMatch = result.match(urlPattern);

              if (urlMatch) {
                const url = urlMatch[0];
                const emailMatch = url.match(emailPattern);
                const email = emailMatch ? decodeURIComponent(emailMatch[1]) : null;

                console.log("Extracted email:", email); // Log the extracted email

                // Push the email to the webhook
                if (email) {
                  pushToWebhook(email);
                } else {
                  console.warn("No email found in QR code.");
                }
              } else {
                console.error("Scanned result is not a valid URL:", result);
              }
            });

            qrScanner.start();

            async function pushToWebhook(email) {
              const webhookUrl = "udy914hedcmo2pflks5pmjkj5ywfhd02@hook.us1.make.com
      "; // Remove credentials from URL

              console.log("Sending email to webhook:", email);

              try {
                const response = await fetch(webhookUrl, {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify({ email: email }), // Use email instead of log
                });

                if (!response.ok) {
                  throw new Error(
                    "Network response was not ok: " + response.statusText,
                  );
                }

                const data = await response.json();
                console.log("Successfully sent to webhook:", data);
              } catch (error) {
                console.error("Error sending to webhook:", error);
              }
            }
    </script>
  </body>
</html>
